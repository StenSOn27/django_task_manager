{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}Task List - Task Manager{% endblock %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/task_styles.css' %}" />

{% csrf_token %}
<!-- Task Header -->
<div>
  <h1 style="margin: 30px; font-size: 28px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">Task List</h1>
  <p style="margin: 10px 0 30px 30px; color: #6b7280; font-size: 14px;">List of all tasks</p>
</div>
<div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background-color: #f8f9fe; border-radius: 0.375rem 0.375rem 0 0; box-shadow: 0 0 2rem 0 rgba(136, 152, 170, 0.15); margin: 0 1.5rem; margin-bottom: 0;">
    <div style="display: flex; align-items: center;">
        <a href="{% url 'manager:task-create' %}" style="display: flex; align-items: center; justify-content: center; background-color: #fb6340; color: white; border: none; border-radius: 0.375rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; text-decoration: none; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#e55a2f'" onmouseout="this.style.backgroundColor='#fb6340'">
            <i class="fas fa-plus" style="margin-right: 0.5rem;"></i>
            <span>New Task</span>
        </a>
    </div>
      <form action="" method="get" class="search-form">
        <div class="form-group flex-grow-1 mb-0" style="margin-bottom: 0;">
          {{ search_form|crispy }}
        </div>
        <button type="submit" class="search-button">
          <i class="fas fa-search" style="margin-right: 6px;"></i>Search
        </button>
      </form>
</div>

<!-- Task Container -->
<div style="background-color: white; border-radius: 0 0 0.375rem 0.375rem; box-shadow: 0 0 2rem 0 rgba(136, 152, 170, 0.15); margin: 0 1.5rem; overflow: visible;">
    {% for task in task_list %}
    <div style="display: flex; align-items: flex-start; padding: 1rem; border-bottom: 1px solid #e9ecef; transition: background-color 0.2s; {% if task.is_completed %}background-color: #f8f9fe;{% endif %}" onmouseover="this.style.backgroundColor='#f8f9fe'" onmouseout="this.style.backgroundColor='{% if task.is_completed %}#f8f9fe{% else %}white{% endif %}'" data-task-id="{{ task.id }}">
        <div style="margin-right: 1rem; padding-top: 0.25rem;">
            <input type="checkbox" 
                   id="task-{{ task.id }}" 
                   style="width: 18px; height: 18px; cursor: pointer;"
                   {% if task.is_completed %}checked{% endif %}
                   onchange="toggleTaskStatus({{ task.id }}, this)">
        </div>
        
        <div style="flex: 1; min-width: 0;">
            <h3 style="font-size: 1rem; font-weight: 600; margin: 0 0 0.5rem 0; color: #172b4d; line-height: 1.4; transition: all 0.3s ease; {% if task.is_completed %}text-decoration: line-through; opacity: 0.7;{% endif %}">{{ task.name }}</h3>
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem; gap: 0.75rem; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; font-size: 0.875rem; color: #8898aa;">
                    <i class="far fa-clock" style="margin-right: 0.25rem;"></i>
                    <span>{{ task.deadline|date:"M d, Y" }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; text-transform: uppercase; transition: background-color 0.3s ease, color 0.3s ease; background-color: {% if task.is_completed %}#2dce89{% else %}#5e72e4{% endif %}; color: white;" id="status-badge-{{ task.id }}">
                        {% if task.is_completed %}COMPLETED{% else %}IN PROGRESS{% endif %}
                    </div>
                    {% if task.priority %}
                    <div style="display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; text-transform: uppercase; 
                        {% if task.priority|lower == 'urgent' %}
                            background-color: #dc2626; color: white;
                        {% elif task.priority|lower == 'high' %}
                            background-color: #f5365c; color: white;
                        {% elif task.priority|lower == 'medium' %}
                            background-color: #fb6340; color: white;
                        {% elif task.priority|lower == 'low' %}
                            background-color: #ffd600; color: #172b4d;
                        {% endif %}">
                        {{ task.priority|upper }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <p class="task-description" style="font-size: 0.875rem; color: #525f7f; margin: 0; line-height: 1.5; transition: opacity 0.3s ease; {% if task.is_completed %}opacity: 0.6;{% endif %}">
                {% if task.description %}{{ task.description }}{% else %}Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi pulvinar feugiat consequat. Duis lacus nibh, sagittis id varius vel, aliquet non augue.{% endif %}
            </p>
        </div>
        
        <div class="dropdown" style="position: relative; margin-left: 1rem;">
          <input type="radio" name="dropdown-control" id="dropdown-toggle-{{ task.id }}">
          <label for="dropdown-toggle-{{ task.id }}" class="dropdown-toggle">
            <i class="fas fa-ellipsis-h"></i>
          </label>
          <div class="dropdown-content">
            <a href="{% url 'manager:task-detail' task.id %}"><i class="fas fa-eye" style="margin-right: 6px;"></i> View</a>
            <a href="{% url 'manager:task-update' task.id %}"><i class="fas fa-edit" style="margin-right: 6px;"></i> Edit</a>
            <a href="{% url 'manager:task-delete' task.id %}"><i class="fas fa-trash" style="margin-right: 6px;"></i> Delete</a>
          </div>
          <label for="dropdown-close" class="dropdown-close"></label>
        </div>
    </div>
    {% empty %}
    <div style="padding: 2rem; text-align: center; color: #8898aa;">
        <p>No tasks found. Create a new task to get started.</p>
    </div>
    {% endfor %}
    
    <!-- Hidden radio button to close all dropdowns -->
    <input type="radio" name="dropdown-control" id="dropdown-close" checked style="display: none;">
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function toggleTaskStatus(taskId, checkboxElem) {
    fetch(`/tasks/${taskId}/toggle-status/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("Network response error");
      return response.json();
    })
    .then(data => {
      if (data.status === "success") {
        const taskItem = checkboxElem.closest('[data-task-id]');
        const badge = document.getElementById(`status-badge-${taskId}`);
        const title = taskItem.querySelector('h3');
        const description = taskItem.querySelector('p');

        if (data.is_completed) {
          taskItem.style.backgroundColor = '#f8f9fe';
          title.style.textDecoration = 'line-through';
          title.style.opacity = '0.7';
          description.style.opacity = '0.6';
          badge.style.backgroundColor = '#2dce89';
          badge.textContent = 'COMPLETED';
        } else {
          taskItem.style.backgroundColor = 'white';
          title.style.textDecoration = 'none';
          title.style.opacity = '1';
          description.style.opacity = '1';
          badge.style.backgroundColor = '#5e72e4';
          badge.textContent = 'IN PROGRESS';
        }
      }
    })
    .catch(error => {
      console.error("Updating task status:", error);
    });
  }
</script>
{% endblock %}